<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh D·ªãch Ti·∫øng √ä-ƒë√™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f4f8;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-button.active {
            border-color: #2563eb;
            color: #2563eb;
            background-color: #dbeafe;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dictionary-item:hover {
            background-color: #f9fafb;
            transform: translateX(4px);
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="min-h-screen p-4 sm:p-6 md:p-8 flex flex-col items-center">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-slate-900">Tr√¨nh D·ªãch Ti·∫øng √ä-ƒë√™</h1>
            <p class="mt-2 text-lg text-slate-600">M·ªôt c√¥ng c·ª• hi·ªán ƒë·∫°i ƒë·ªÉ kh√°m ph√° ng√¥n ng·ªØ √ä-ƒë√™</p>
        </header>

        <main class="w-full max-w-4xl mx-auto">
            <div class="card rounded-2xl shadow-lg p-6 md:p-8">
                <p class="mb-6 text-slate-700 text-center">
                    ·ª®ng d·ª•ng n√†y cho ph√©p b·∫°n d·ªãch vƒÉn b·∫£n, t·∫°o v√≠ d·ª•, t√≥m t·∫Øt n·ªôi dung v√† th·∫≠m ch√≠ d·ªãch t·ª´ h√¨nh ·∫£nh. B·∫Øt ƒë·∫ßu b·∫±ng c√°ch nh·∫≠p vƒÉn b·∫£n v√†o √¥ b√™n d∆∞·ªõi.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col space-y-4">
                        <label for="inputText" class="font-semibold text-slate-800">VƒÉn b·∫£n g·ªëc (Vi·ªát ho·∫∑c √ä-ƒë√™)</label>
                        <div class="relative w-full">
                            <textarea id="inputText" rows="8" class="w-full p-4 rounded-lg border-2 border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300 resize-none" placeholder="Nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch..."></textarea>
                            <button id="recordButton" title="Ghi √¢m gi·ªçng n√≥i" class="absolute bottom-3 right-3 p-2 rounded-full bg-slate-100 hover:bg-slate-200 transition">
                                <span class="record-icon">üéôÔ∏è</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-4">
                        <label for="outputText" class="font-semibold text-slate-800">K·∫øt qu·∫£ d·ªãch</label>
                         <div class="relative w-full">
                            <textarea id="outputText" rows="8" readonly class="w-full p-4 rounded-lg bg-slate-100 border-2 border-slate-200 resize-none" placeholder="K·∫øt qu·∫£ d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></textarea>
                            <button id="speakTranslatedTextButton" title="Ph√°t √¢m vƒÉn b·∫£n" class="absolute bottom-3 right-3 p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition">
                                <span>üîä</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="translateButton" class="w-full sm:w-auto flex items-center justify-center gap-2 px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                        <span class="button-icon">‚ú®</span>
                        <span class="button-text">D·ªãch</span>
                    </button>
                    <button id="generateExamplesButton" class="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-transform transform hover:scale-105">
                        <span class="button-icon">üí°</span>
                        <span class="button-text">T·∫°o v√≠ d·ª•</span>
                    </button>
                    <button id="summarizeExplainButton" class="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-transform transform hover:scale-105">
                        <span class="button-icon">üìù</span>
                        <span class="button-text">T√≥m t·∫Øt</span>
                    </button>
                </div>
                 <div id="additionalOutputWrapper" class="mt-6 hidden">
                    <label for="additionalOutput" class="font-semibold text-slate-800">K·∫øt qu·∫£ b·ªï sung</label>
                    <div class="relative w-full mt-2">
                        <textarea id="additionalOutput" rows="4" readonly class="w-full p-4 rounded-lg bg-slate-100 border-2 border-slate-200 resize-none"></textarea>
                        <button id="speakAdditionalTextButton" title="Ph√°t √¢m vƒÉn b·∫£n" class="absolute bottom-3 right-3 p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition">
                             <span>üîä</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Write Essay Section -->
            <div class="card rounded-2xl shadow-lg p-6 md:p-8 mt-10">
                <h2 class="text-2xl font-bold text-slate-900 mb-4 text-center">Vi·∫øt B√†i VƒÉn T·ª´ G·ª£i √ù</h2>
                <p class="mb-6 text-slate-700 text-center">
                    Nh·∫≠p c√°c t·ª´ kh√≥a ho·∫∑c g·ª£i √Ω c·ªßa b·∫°n v√†o ƒë√¢y, v√† Gemini s·∫Ω gi√∫p b·∫°n t·∫°o ra m·ªôt b√†i vƒÉn ho√†n ch·ªânh.
                </p>
                <div class="flex flex-col space-y-4">
                    <label for="essayKeywords" class="font-semibold text-slate-800">T·ª´ kh√≥a/G·ª£i √Ω:</label>
                    <textarea id="essayKeywords" rows="4" class="w-full p-4 rounded-lg border-2 border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300 resize-none" placeholder="V√≠ d·ª•: L·ª£i √≠ch c·ªßa vi·ªác h·ªçc ti·∫øng √ä-ƒë√™, vƒÉn h√≥a d√¢n t·ªôc, b·∫£o t·ªìn ng√¥n ng·ªØ..."></textarea>
                </div>
                <button id="generateEssayButton" class="mt-6 w-full flex items-center justify-center gap-2 px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                    <span class="button-icon">‚úçÔ∏è</span>
                    <span class="button-text">T·∫°o B√†i VƒÉn</span>
                </button>
                <div id="essayOutputWrapper" class="mt-6 hidden">
                    <label for="essayOutput" class="font-semibold text-slate-800">B√†i vƒÉn ƒë√£ t·∫°o:</label>
                    <div class="relative w-full mt-2">
                        <textarea id="essayOutput" rows="10" readonly class="w-full p-4 rounded-lg bg-slate-100 border-2 border-slate-200 resize-none"></textarea>
                        <button id="speakEssayTextButton" title="Ph√°t √¢m b√†i vƒÉn" class="absolute bottom-3 right-3 p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition">
                             <span>üîä</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-10">
                <div class="mb-4 border-b border-slate-300 flex justify-center">
                    <button data-tab="imageTab" class="tab-button text-lg font-medium py-2 px-6 border-b-2 transition active">D·ªãch t·ª´ ·∫£nh</button>
                    <button data-tab="personalDictionaryTab" class="tab-button text-lg font-medium py-2 px-6 border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition">T·ª´ ƒëi·ªÉn c√° nh√¢n</button>
                    <button data-tab="sharedDictionaryTab" class="tab-button text-lg font-medium py-2 px-6 border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition">T·ª´ ƒëi·ªÉn chung</button>
                </div>

                <div class="tab-content card rounded-2xl shadow-lg p-6 md:p-8">
                    <!-- Image Translation Tab -->
                    <div id="imageTab" class="space-y-6">
                        <p class="text-slate-700">T·∫£i l√™n m·ªôt h√¨nh ·∫£nh ƒë·ªÉ tr√≠ch xu·∫•t vƒÉn b·∫£n v√† th·ª±c hi·ªán d·ªãch ho·∫∑c gi·∫£i b√†i t·∫≠p ti·∫øng √ä-ƒë√™.</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="takePhotoButton" class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                                <span class="button-icon">üì∏</span>
                                <span class="button-text">Ch·ª•p ·∫£nh</span>
                            </button>
                            <button id="chooseImageButton" class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105">
                                <span class="button-icon">üìÇ</span>
                                <span class="button-text">Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán</span>
                            </button>
                        </div>
                        <input type="file" id="imageInput" class="hidden" accept="image/*" capture="environment">

                        <div class="p-6 border-2 border-dashed border-slate-300 rounded-lg text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition" id="dropZone">
                            <div id="imagePlaceholder">
                                <span class="text-4xl">üñºÔ∏è</span>
                                <p class="mt-2 text-slate-600">K√©o v√† th·∫£ ·∫£nh v√†o ƒë√¢y, ho·∫∑c <span class="font-semibold text-blue-600">nh·∫•n ƒë·ªÉ ch·ªçn file</span></p>
                            </div>
                            <div id="imagePreviewWrapper" class="hidden relative">
                                <img id="imagePreview" class="max-h-60 mx-auto rounded-md shadow-md"/>
                                <button id="removeImageButton" class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md text-red-500 hover:bg-red-700 text-xl font-bold">&times;</button>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="translateTextFromImageButton" class="flex-1 flex items-center justify-center gap-2 px-8 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:transform-none">
                                <span class="button-icon">‚ÜîÔ∏è</span>
                                <span class="button-text">Tr√≠ch xu·∫•t vƒÉn b·∫£n t·ª´ ·∫£nh</span>
                            </button>
                            <button id="solveEdeProblemButton" class="flex-1 flex items-center justify-center gap-2 px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:transform-none">
                                <span class="button-icon">üß†</span>
                                <span class="button-text">Gi·∫£i b√†i t·∫≠p t·ª´ ·∫£nh</span>
                            </button>
                        </div>
                    </div>

                    <!-- Personal Dictionary Tab -->
                    <div id="personalDictionaryTab" class="hidden space-y-6">
                        <p class="text-slate-700">X√¢y d·ª±ng t·ª´ ƒëi·ªÉn c√° nh√¢n c·ªßa ri√™ng b·∫°n. C√°c b·∫£n d·ªãch b·∫°n th√™m v√†o ƒë√¢y s·∫Ω ƒë∆∞·ª£c ∆∞u ti√™n s·ª≠ d·ª•ng, gi√∫p c·∫£i thi·ªán ƒë·ªô ch√≠nh x√°c theo th·ªùi gian.</p>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Th√™m t·ª´ m·ªõi</h3>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <input type="text" id="newEdeText" placeholder="Nh·∫≠p t·ª´ ti·∫øng √ä-ƒë√™" class="flex-1 p-3 rounded-lg border-2 border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                <input type="text" id="newVietText" placeholder="Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát" class="flex-1 p-3 rounded-lg border-2 border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                <button id="addTermButton" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">Th√™m</button>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-slate-200">
                            <h3 class="lg font-semibold mb-3">C√°c b·∫£n d·ªãch c·ªßa b·∫°n</h3>
                            <div id="personalTranslationsList" class="max-h-80 overflow-y-auto space-y-3 pr-2">
                                <p class="text-slate-500 text-center py-4" id="personalDictionaryPlaceholder">T·ª´ ƒëi·ªÉn c√° nh√¢n c·ªßa b·∫°n ƒëang tr·ªëng.</p>
                                <!-- Personal dictionary items will be rendered here -->
                            </div>
                            <button id="uploadFromFileButton" class="mt-4 w-full flex items-center justify-center gap-2 px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                                <span class="button-icon">‚¨ÜÔ∏è</span>
                                <span class="button-text">T·∫£i d·ªØ li·ªáu t·ª´ File (m·∫´u)</span>
                            </button>
                        </div>
                    </div>

                    <!-- Shared Dictionary Tab -->
                    <div id="sharedDictionaryTab" class="hidden space-y-6">
                        <p class="text-slate-700">Kh√°m ph√° v√† s·ª≠ d·ª•ng c√°c t·ª´ ƒë∆∞·ª£c chia s·∫ª b·ªüi c·ªông ƒë·ªìng. B·∫°n c≈©ng c√≥ th·ªÉ ƒë√≥ng g√≥p t·ª´ c·ªßa m√¨nh t·ª´ t·ª´ ƒëi·ªÉn c√° nh√¢n.</p>
                        <div class="mt-6 pt-4 border-t border-slate-200">
                            <h3 class="lg font-semibold mb-3">C√°c t·ª´ ƒë∆∞·ª£c chia s·∫ª</h3>
                            <div id="sharedTranslationsList" class="max-h-80 overflow-y-auto space-y-3 pr-2">
                                <p class="text-slate-500 text-center py-4" id="sharedDictionaryPlaceholder">T·ª´ ƒëi·ªÉn chung ƒëang tr·ªëng ho·∫∑c ƒëang t·∫£i...</p>
                                <!-- Shared dictionary items will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-10 text-slate-500 text-sm">
            <p>Ph√°t tri·ªÉn b·ªüi TheBang &copy; 2025</p>
            <p id="userIdDisplay" class="mt-1 opacity-70">ƒêang ch·ªù x√°c th·ª±c ng∆∞·ªùi d√πng...</p>
        </footer>
    </div>

<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, deleteDoc, onSnapshot, doc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {

        const state = {
            isLoading: false,
            currentTab: 'imageTab',
            userId: null,
            personalDictionary: [], // Now managed by Firestore
            sharedDictionary: [], // Now managed by Firestore
            selectedImageFile: null,
            isGeneratingEssay: false,
            db: null,
            auth: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            isAuthReady: false // To track Firebase auth readiness
        };

        const ui = {
            inputText: document.getElementById('inputText'),
            outputText: document.getElementById('outputText'),
            additionalOutput: document.getElementById('additionalOutput'),
            additionalOutputWrapper: document.getElementById('additionalOutputWrapper'),
            translateButton: document.getElementById('translateButton'),
            generateExamplesButton: document.getElementById('generateExamplesButton'),
            summarizeExplainButton: document.getElementById('summarizeExplainButton'),
            recordButton: document.getElementById('recordButton'),
            speakTranslatedTextButton: document.getElementById('speakTranslatedTextButton'),
            speakAdditionalTextButton: document.getElementById('speakAdditionalTextButton'),
            tabs: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content > div'),
            imageInput: document.getElementById('imageInput'),
            dropZone: document.getElementById('dropZone'),
            imagePlaceholder: document.getElementById('imagePlaceholder'),
            imagePreviewWrapper: document.getElementById('imagePreviewWrapper'),
            imagePreview: document.getElementById('imagePreview'),
            removeImageButton: document.getElementById('removeImageButton'),
            takePhotoButton: document.getElementById('takePhotoButton'),
            chooseImageButton: document.getElementById('chooseImageButton'),
            translateTextFromImageButton: document.getElementById('translateTextFromImageButton'),
            solveEdeProblemButton: document.getElementById('solveEdeProblemButton'),
            newEdeText: document.getElementById('newEdeText'),
            newVietText: document.getElementById('newVietText'),
            addTermButton: document.getElementById('addTermButton'),
            personalTranslationsList: document.getElementById('personalTranslationsList'), // Renamed
            personalDictionaryPlaceholder: document.getElementById('personalDictionaryPlaceholder'), // Renamed
            sharedTranslationsList: document.getElementById('sharedTranslationsList'), // New
            sharedDictionaryPlaceholder: document.getElementById('sharedDictionaryPlaceholder'), // New
            userIdDisplay: document.getElementById('userIdDisplay'),
            essayKeywords: document.getElementById('essayKeywords'),
            generateEssayButton: document.getElementById('generateEssayButton'),
            essayOutput: document.getElementById('essayOutput'),
            essayOutputWrapper: document.getElementById('essayOutputWrapper'),
            speakEssayTextButton: document.getElementById('speakEssayTextButton'),
            uploadFromFileButton: document.getElementById('uploadFromFileButton'), // New button
        };
        
        // Function to call Gemini API
        async function callGeminiAPI(prompt, imageData = null, model = 'gemini-2.0-flash') {
            // THAY TH·∫æ "YOUR_API_KEY_HERE" B·∫∞NG KH√ìA API TH·ª∞C C·ª¶A B·∫†N T·∫†I ƒê√ÇY
            // V√≠ d·ª•: const apiKey = "AIzaSyC_YOUR_ACTUAL_API_KEY_HERE_12345";
            const apiKey = "AIzaSyDJ7ECoH5VagzAqaZ5QrBFS2Yx-mWbHmOg"; // Leave empty for Canvas to auto-provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            let chatHistory = [];
            let parts = [{ text: prompt }];

            if (imageData) {
                parts.push({
                    inlineData: {
                        mimeType: imageData.mimeType,
                        data: imageData.data
                    }
                });
            }
            chatHistory.push({ role: "user", parts: parts });

            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    throw new Error(`L·ªói API: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Unexpected API response structure:", result);
                    throw new Error("C·∫•u tr√∫c ph·∫£n h·ªìi API kh√¥ng mong mu·ªën.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw error;
            }
        }

        function setLoadingState(button, isLoading, originalText) {
            const textSpan = button.querySelector('.button-text');
            const iconSpan = button.querySelector('.button-icon');
            
            if (isLoading) {
                state.isLoading = true;
                button.disabled = true;
                textSpan.textContent = 'ƒêang x·ª≠ l√Ω...';
                iconSpan.innerHTML = '<div class="loader"></div>';
            } else {
                state.isLoading = false;
                button.disabled = false;
                textSpan.textContent = originalText;
                switch(originalText) {
                    case 'D·ªãch': iconSpan.innerHTML = '‚ú®'; break;
                    case 'T·∫°o v√≠ d·ª•': iconSpan.innerHTML = 'üí°'; break;
                    case 'T√≥m t·∫Øt': iconSpan.innerHTML = 'üìù'; break;
                    case 'Tr√≠ch xu·∫•t vƒÉn b·∫£n t·ª´ ·∫£nh': iconSpan.innerHTML = '‚ÜîÔ∏è'; break;
                    case 'Gi·∫£i b√†i t·∫≠p t·ª´ ·∫£nh': iconSpan.innerHTML = 'üß†'; break;
                    case 'T·∫°o B√†i VƒÉn': iconSpan.innerHTML = '‚úçÔ∏è'; break;
                    case 'Ch·ª•p ·∫£nh': iconSpan.innerHTML = 'üì∏'; break;
                    case 'Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán': iconSpan.innerHTML = 'üìÇ'; break;
                    case 'Th√™m': iconSpan.innerHTML = ''; break; // No icon for Add button
                    case 'Chia s·∫ª': iconSpan.innerHTML = 'ü§ù'; break; // New icon for Share button
                    case 'T·∫£i d·ªØ li·ªáu t·ª´ File (m·∫´u)': iconSpan.innerHTML = '‚¨ÜÔ∏è'; break; // New icon for upload button
                }
            }
        }
        
        function renderPersonalDictionary() {
            ui.personalTranslationsList.innerHTML = '';
            if (state.personalDictionary.length === 0) {
                ui.personalTranslationsList.appendChild(ui.personalDictionaryPlaceholder);
                ui.personalDictionaryPlaceholder.classList.remove('hidden');
            } else {
                if (ui.personalDictionaryPlaceholder) {
                    ui.personalDictionaryPlaceholder.classList.add('hidden');
                }
                state.personalDictionary.forEach(term => {
                    const item = document.createElement('div');
                    item.className = 'dictionary-item flex justify-between items-center p-3 rounded-lg border border-slate-200 transition-all duration-300';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-800">${term.ede}</p>
                            <p class="text-sm text-slate-500">${term.viet}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${term.id}" data-ede="${term.ede}" data-viet="${term.viet}" class="share-term-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition-transform transform hover:scale-105">Chia s·∫ª</button>
                            <button data-id="${term.id}" class="delete-term-btn text-red-500 hover:text-red-700 p-1 rounded-full text-lg">&times;</button>
                        </div>
                    `;
                    ui.personalTranslationsList.appendChild(item);
                });
            }
        }

        function renderSharedDictionary() {
            ui.sharedTranslationsList.innerHTML = '';
            if (state.sharedDictionary.length === 0) {
                ui.sharedTranslationsList.appendChild(ui.sharedDictionaryPlaceholder);
                ui.sharedDictionaryPlaceholder.classList.remove('hidden');
            } else {
                if (ui.sharedDictionaryPlaceholder) {
                    ui.sharedDictionaryPlaceholder.classList.add('hidden');
                }
                state.sharedDictionary.forEach(term => {
                    const item = document.createElement('div');
                    item.className = 'dictionary-item flex justify-between items-center p-3 rounded-lg border border-slate-200 transition-all duration-300';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-800">${term.ede}</p>
                            <p class="text-sm text-slate-500">${term.viet}</p>
                            <p class="text-xs text-slate-400">ƒê√≥ng g√≥p b·ªüi: ${term.contributorId.substring(0, 8)}...</p>
                        </div>
                    `;
                    ui.sharedTranslationsList.appendChild(item);
                });
            }
        }

        async function handleTranslate() {
            if (state.isLoading || !ui.inputText.value.trim()) return;
            setLoadingState(ui.translateButton, true, 'D·ªãch');
            ui.outputText.value = '';
            ui.additionalOutputWrapper.classList.add('hidden');
            
            const inputTextLower = ui.inputText.value.trim().toLowerCase();
            let translatedText = '';

            // 1. Check personal dictionary first
            const personalMatch = state.personalDictionary.find(t => t.ede.toLowerCase() === inputTextLower || t.viet.toLowerCase() === inputTextLower);
            if (personalMatch) {
                translatedText = personalMatch.ede.toLowerCase() === inputTextLower ? personalMatch.viet : personalMatch.ede;
                translatedText += " (t·ª´ t·ª´ ƒëi·ªÉn c√° nh√¢n)";
                ui.outputText.value = translatedText;
                setLoadingState(ui.translateButton, false, 'D·ªãch');
                return;
            }

            // 2. Check shared dictionary
            const sharedMatch = state.sharedDictionary.find(t => t.ede.toLowerCase() === inputTextLower || t.viet.toLowerCase() === inputTextLower);
            if (sharedMatch) {
                translatedText = sharedMatch.ede.toLowerCase() === inputTextLower ? sharedMatch.viet : sharedMatch.ede;
                translatedText += " (t·ª´ t·ª´ ƒëi·ªÉn chung)";
                ui.outputText.value = translatedText;
                setLoadingState(ui.translateButton, false, 'D·ªãch');
                return;
            }
            
            // 3. Fallback to Gemini API
            const prompt = `B·∫°n l√† m·ªôt c√¥ng c·ª• d·ªãch thu·∫≠t chuy√™n nghi·ªáp. H√£y d·ªãch vƒÉn b·∫£n sau ƒë√¢y gi·ªØa ti·∫øng Vi·ªát v√† ti·∫øng √ä-ƒë√™. N·∫øu vƒÉn b·∫£n l√† ti·∫øng Vi·ªát, h√£y d·ªãch sang ti·∫øng √ä-ƒë√™. N·∫øu vƒÉn b·∫£n l√† ti·∫øng √ä-ƒë√™, h√£y d·ªãch sang ti·∫øng Vi·ªát. Ch·ªâ tr·∫£ v·ªÅ vƒÉn b·∫£n ƒë√£ d·ªãch, kh√¥ng th√™m b·∫•t k·ª≥ gi·∫£i th√≠ch n√†o. VƒÉn b·∫£n c·∫ßn d·ªãch: ${ui.inputText.value}`;

            try {
                translatedText = await callGeminiAPI(prompt);
                ui.outputText.value = translatedText;
            } catch (error) {
                ui.outputText.value = `ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh d·ªãch: ${error.message}`;
            } finally {
                setLoadingState(ui.translateButton, false, 'D·ªãch');
            }
        }

        async function handleGenerateExamples() {
            if (state.isLoading || !ui.outputText.value.trim() || ui.outputText.value.includes("K·∫øt qu·∫£ d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y")) return;
            setLoadingState(ui.generateExamplesButton, true, 'T·∫°o v√≠ d·ª•');
            ui.additionalOutput.value = '';
            
            const prompt = `T·∫°o 3 c√¢u v√≠ d·ª• s·ª≠ d·ª•ng t·ª´ ho·∫∑c c·ª•m t·ª´ "${ui.outputText.value}" trong ng·ªØ c·∫£nh kh√°c nhau. C√°c c√¢u v√≠ d·ª• n√†y n√™n ƒë∆∞·ª£c d·ªãch sang ng√¥n ng·ªØ c√≤n l·∫°i (n·∫øu t·ª´ g·ªëc l√† ti·∫øng Vi·ªát, v√≠ d·ª• l√† ti·∫øng √ä-ƒë√™ v√† ng∆∞·ª£c l·∫°i). Ch·ªâ tr·∫£ v·ªÅ c√°c c√¢u v√≠ d·ª•, m·ªói c√¢u tr√™n m·ªôt d√≤ng m·ªõi, kh√¥ng th√™m b·∫•t k·ª≥ gi·∫£i th√≠ch n√†o.`;

            try {
                const examples = await callGeminiAPI(prompt);
                ui.additionalOutput.value = examples;
                ui.additionalOutputWrapper.classList.remove('hidden');
            } catch (error) {
                ui.additionalOutput.value = `ƒê√£ x·∫£y ra l·ªói khi t·∫°o v√≠ d·ª•: ${error.message}`;
            } finally {
                setLoadingState(ui.generateExamplesButton, false, 'T·∫°o v√≠ d·ª•');
            }
        }

        async function handleSummarize() {
            if (state.isLoading || !ui.outputText.value.trim() || ui.outputText.value.includes("K·∫øt qu·∫£ d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y")) return;
            setLoadingState(ui.summarizeExplainButton, true, 'T√≥m t·∫Øt');
            ui.additionalOutput.value = '';

            const prompt = `T√≥m t·∫Øt ho·∫∑c gi·∫£i th√≠ch ng·∫Øn g·ªçn √Ω nghƒ©a c·ªßa vƒÉn b·∫£n sau: "${ui.outputText.value}". N·∫øu vƒÉn b·∫£n ph·ª©c t·∫°p, h√£y gi·∫£i th√≠ch c√°c ƒëi·ªÉm ch√≠nh. Ch·ªâ tr·∫£ v·ªÅ ph·∫ßn t√≥m t·∫Øt/gi·∫£i th√≠ch, kh√¥ng th√™m b·∫•t k·ª≥ gi·∫£i th√≠ch n√†o kh√°c.`;

            try {
                const summary = await callGeminiAPI(prompt);
                ui.additionalOutput.value = summary;
                ui.additionalOutputWrapper.classList.remove('hidden');
            } catch (error) {
                ui.additionalOutput.value = `ƒê√£ x·∫£y ra l·ªói khi t√≥m t·∫Øt/gi·∫£i th√≠ch: ${error.message}`;
            } finally {
                setLoadingState(ui.summarizeExplainButton, false, 'T√≥m t·∫Øt');
            }
        }

        async function handleGenerateEssay() {
            if (state.isLoading || !ui.essayKeywords.value.trim()) return;
            setLoadingState(ui.generateEssayButton, true, 'T·∫°o B√†i VƒÉn');
            ui.essayOutput.value = '';
            ui.essayOutputWrapper.classList.add('hidden');

            const prompt = `Vi·∫øt m·ªôt b√†i vƒÉn v·ªÅ ch·ªß ƒë·ªÅ d·ª±a tr√™n c√°c t·ª´ kh√≥a sau: "${ui.essayKeywords.value}". B√†i vƒÉn n√™n c√≥ ƒë·ªô d√†i v·ª´a ph·∫£i, kho·∫£ng 200-300 t·ª´, v√† c√≥ c·∫•u tr√∫c r√µ r√†ng (m·ªü b√†i, th√¢n b√†i, k·∫øt lu·∫≠n).`;

            try {
                const essay = await callGeminiAPI(prompt);
                ui.essayOutput.value = essay;
                ui.essayOutputWrapper.classList.remove('hidden');
            } catch (error) {
                ui.essayOutput.value = `ƒê√£ x·∫£y ra l·ªói khi t·∫°o b√†i vƒÉn: ${error.message}`;
            } finally {
                setLoadingState(ui.generateEssayButton, false, 'T·∫°o B√†i VƒÉn');
            }
        }
        
        function setupTabs() {
            ui.tabs.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    if (tabId === state.currentTab) return;

                    ui.tabs.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    ui.tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(tabId).classList.remove('hidden');
                    
                    state.currentTab = tabId;
                });
            });
        }

        function handleImageSelection(file) {
            if (file && file.type.startsWith('image/')) {
                state.selectedImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    ui.imagePreview.src = e.target.result;
                    ui.imagePlaceholder.classList.add('hidden');
                    ui.imagePreviewWrapper.classList.remove('hidden');
                    ui.translateTextFromImageButton.disabled = false;
                    ui.solveEdeProblemButton.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleTranslateTextFromImage() {
            if(state.isLoading || !state.selectedImageFile) return;
            setLoadingState(ui.translateTextFromImageButton, true, 'Tr√≠ch xu·∫•t vƒÉn b·∫£n t·ª´ ·∫£nh');
            ui.inputText.value = '';
            ui.outputText.value = '';
            ui.additionalOutput.value = '';
            ui.additionalOutputWrapper.classList.add('hidden');

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Image = reader.result.split(',')[1];
                const mimeType = state.selectedImageFile.type;

                const prompt = `Tr√≠ch xu·∫•t t·∫•t c·∫£ vƒÉn b·∫£n t·ª´ h√¨nh ·∫£nh n√†y. Ch·ªâ xu·∫•t ra vƒÉn b·∫£n ƒë√£ tr√≠ch xu·∫•t, kh√¥ng th√™m b·∫•t k·ª≥ gi·∫£i th√≠ch n√†o kh√°c.`;
                
                try {
                    const extractedText = await callGeminiAPI(prompt, { data: base64Image, mimeType: mimeType });
                    ui.inputText.value = extractedText;
                    ui.outputText.value = "VƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c tr√≠ch xu·∫•t. Vui l√≤ng nh·∫•n 'D·ªãch' ƒë·ªÉ d·ªãch.";
                } catch (error) {
                    ui.outputText.value = `ƒê√£ x·∫£y ra l·ªói khi tr√≠ch xu·∫•t vƒÉn b·∫£n t·ª´ ·∫£nh: ${error.message}`;
                } finally {
                    setLoadingState(ui.translateTextFromImageButton, false, 'Tr√≠ch xu·∫•t vƒÉn b·∫£n t·ª´ ·∫£nh');
                }
            };
            reader.readAsDataURL(state.selectedImageFile);
        }

        async function handleSolveEdeProblem() {
            if(state.isLoading || !state.selectedImageFile) return;
            setLoadingState(ui.solveEdeProblemButton, true, 'Gi·∫£i b√†i t·∫≠p t·ª´ ·∫£nh');
            ui.outputText.value = '';
            ui.additionalOutput.value = '';
            ui.additionalOutputWrapper.classList.add('hidden');

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Image = reader.result.split(',')[1];
                const mimeType = state.selectedImageFile.type;

                const prompt = `T·ª´ h√¨nh ·∫£nh ƒë∆∞·ª£c cung c·∫•p, h√£y tr√≠ch xu·∫•t vƒÉn b·∫£n ti·∫øng √ä-ƒë√™. Sau ƒë√≥, ph√¢n t√≠ch n·ªôi dung n√†y nh∆∞ m·ªôt b√†i t·∫≠p ho·∫∑c c√¢u h·ªèi ti·∫øng √ä-ƒë√™. Cung c·∫•p l·ªùi gi·∫£i th√≠ch chi ti·∫øt, ƒë√°p √°n (n·∫øu c√≥), v√† b·∫•t k·ª≥ th√¥ng tin ng·ªØ ph√°p ho·∫∑c t·ª´ v·ª±ng li√™n quan n√†o ƒë·ªÉ gi√∫p ng∆∞·ªùi d√πng hi·ªÉu r√µ. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.`;
                
                try {
                    const solutionText = await callGeminiAPI(prompt, { data: base64Image, mimeType: mimeType });
                    ui.outputText.value = "K·∫øt qu·∫£ gi·∫£i b√†i t·∫≠p t·ª´ ·∫£nh (xem ph·∫ßn b·ªï sung):";
                    ui.additionalOutput.value = solutionText;
                    ui.additionalOutputWrapper.classList.remove('hidden');
                } catch (error) {
                    ui.outputText.value = `ƒê√£ x·∫£y ra l·ªói khi gi·∫£i b√†i t·∫≠p t·ª´ ·∫£nh: ${error.message}`;
                } finally {
                    setLoadingState(ui.solveEdeProblemButton, false, 'Gi·∫£i b√†i t·∫≠p t·ª´ ·∫£nh');
                }
            };
            reader.readAsDataURL(state.selectedImageFile);
        }
        
        async function handleAddTerm() {
            const ede = ui.newEdeText.value.trim();
            const viet = ui.newVietText.value.trim();
            if (ede && viet && state.db && state.userId) {
                try {
                    await addDoc(collection(state.db, `artifacts/${state.appId}/users/${state.userId}/personal_dictionary`), {
                        ede: ede,
                        viet: viet,
                        createdAt: Date.now()
                    });
                    ui.newEdeText.value = '';
                    ui.newVietText.value = '';
                } catch (e) {
                    console.error("Error adding document to personal dictionary: ", e);
                    alert("ƒê√£ x·∫£y ra l·ªói khi th√™m t·ª´ v√†o t·ª´ ƒëi·ªÉn c√° nh√¢n.");
                }
            } else {
                alert("Vui l√≤ng nh·∫≠p c·∫£ t·ª´ ti·∫øng √ä-ƒë√™ v√† nghƒ©a ti·∫øng Vi·ªát.");
            }
        }

        async function handleDeleteTerm(e) {
            if (e.target.classList.contains('delete-term-btn')) {
                const docId = e.target.dataset.id;
                if (state.db && state.userId && docId) {
                    try {
                        await deleteDoc(doc(state.db, `artifacts/${state.appId}/users/${state.userId}/personal_dictionary`, docId));
                    } catch (e) {
                        console.error("Error removing document from personal dictionary: ", e);
                        alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a t·ª´ kh·ªèi t·ª´ ƒëi·ªÉn c√° nh√¢n.");
                    }
                }
            }
        }

        async function handleShareTerm(e) {
            if (e.target.classList.contains('share-term-btn')) {
                const docId = e.target.dataset.id;
                const ede = e.target.dataset.ede;
                const viet = e.target.dataset.viet;

                if (state.db && state.userId && docId && ede && viet) {
                    try {
                        // Check if the term already exists in the shared dictionary to prevent duplicates
                        const sharedQuery = query(collection(state.db, `artifacts/${state.appId}/public/data/shared_dictionary`));
                        const sharedDocs = await getDocs(sharedQuery);
                        const exists = sharedDocs.docs.some(d => d.data().ede === ede && d.data().viet === viet);

                        if (exists) {
                            alert("T·ª´ n√†y ƒë√£ t·ªìn t·∫°i trong t·ª´ ƒëi·ªÉn chung r·ªìi.");
                            return;
                        }

                        await addDoc(collection(state.db, `artifacts/${state.appId}/public/data/shared_dictionary`), {
                            ede: ede,
                            viet: viet,
                            contributorId: state.userId,
                            createdAt: Date.now()
                        });
                        alert("ƒê√£ chia s·∫ª t·ª´ th√†nh c√¥ng v√†o t·ª´ ƒëi·ªÉn chung!");
                    } catch (e) {
                        console.error("Error sharing term to public dictionary: ", e);
                        alert("ƒê√£ x·∫£y ra l·ªói khi chia s·∫ª t·ª´.");
                    }
                }
            }
        }

        // Function to upload sample data from files
        async function uploadSampleDataFromFile() {
            if (state.isLoading || !state.db || !state.userId) return;
            setLoadingState(ui.uploadFromFileButton, true, 'T·∫£i d·ªØ li·ªáu t·ª´ File (m·∫´u)');

            // Sample data from "T·ª´ ƒëi·ªÉn E-V.doc" and "t√†i li√™u ti·∫øng √™ƒë√™.doc"
            // NOTE: This is a simplified example. In a real application, you'd parse the DOC files.
            // For demonstration, I'm manually extracting a few terms.
            const sampleTerms = [
                { ede: "Kkuh", viet: "ch√†o" },
                { ede: "Ann", viet: "t√™n" },
                { ede: "Ko", viet: "t√¥i" },
                { ede: "Ih", viet: "anh, ch·ªã" },
                { ede: "Hlei", viet: "ai, g√¨" },
                { ede: "Dk gu", viet: "ng·ªìi xu·ªëng" },
                { ede: "Suaih pral", viet: "m·∫°nh kh·ªèe" },
                { ede: "Klei Yun", viet: "ti·∫øng Kinh" },
                { ede: "Hrim", viet: "h·ªçc" },
                { ede: "Hdru√§m hr√†", viet: "quy·ªÉn s√°ch" },
                { ede: "Nao", viet: "ƒëi" },
                { ede: "Sang", viet: "nh√†" },
                { ede: "Mdei", viet: "ngh·ªâ" },
                { ede: "Hru", viet: "ng√†y" },
                { ede: "Hu", viet: "ƒÉn (c∆°m)" },
                { ede: "Kn", viet: "n·∫•u (c∆°m)" },
                { ede: "Anei", viet: "n√†y, ƒë√¢y" },
                { ede: "Bru", viet: "vi·ªác" },
                { ede: "M bru", viet: "l√†m vi·ªác" },
                { ede: "Djam", viet: "rau, canh" },
                { ede: "Mnm", viet: "u·ªëng" },
                { ede: "Kph", viet: "c√† ph√™" },
                { ede: "Ktr", viet: "b·∫Øp" },
                { ede: "Prk", viet: "ti·ªÅn" },
                { ede: "Man", viet: "voi" },
                { ede: "Dli", viet: "r·ª´ng" },
                { ede: "Hl mn\ng", viet: "th√∫ r·ª´ng" },
                { ede: "Kan", viet: "c√°" },
                { ede: "Hdang", viet: "t√¥m" },
                { ede: "Aring", viet: "cua" },
                { ede: "Kpi", viet: "r∆∞·ª£u c·∫ßn" },
                { ede: "Kmr\ng dli", viet: "r·ª´ng c√¢y" },
                { ede: "Knu\k kna", viet: "Ch√≠nh ph·ªß" },
                { ede: "Dju ana", viet: "d√¢n t·ªôc" },
                { ede: "Ala ]ar", viet: "T·ªï qu·ªëc" },
                { ede: "Klei hd^p", viet: "cu·ªôc s·ªëng" },
                { ede: "Mkra mjing", viet: "ch·∫ø bi·∫øn" },
                { ede: "Hgu\m mgup", viet: "ƒëo√†n k·∫øt" },
                { ede: "Yum bhn", viet: "quan tr·ªçng" },
                { ede: "Ao\ knang", viet: "tin t∆∞·ªüng" },
            ];

            try {
                const personalDictCollectionRef = collection(state.db, `artifacts/${state.appId}/users/${state.userId}/personal_dictionary`);
                
                // Get existing terms to avoid duplicates
                const existingDocs = await getDocs(personalDictCollectionRef);
                const existingTerms = new Set(existingDocs.docs.map(doc => `${doc.data().ede.toLowerCase()}-${doc.data().viet.toLowerCase()}`));

                let termsAdded = 0;
                for (const term of sampleTerms) {
                    const termKey = `${term.ede.toLowerCase()}-${term.viet.toLowerCase()}`;
                    if (!existingTerms.has(termKey)) {
                        await addDoc(personalDictCollectionRef, {
                            ede: term.ede,
                            viet: term.viet,
                            createdAt: Date.now()
                        });
                        termsAdded++;
                    }
                }
                alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${termsAdded} t·ª´ m·ªõi v√†o t·ª´ ƒëi·ªÉn c√° nh√¢n c·ªßa b·∫°n.`);
            } catch (error) {
                console.error("Error uploading sample data:", error);
                alert("ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu m·∫´u.");
            } finally {
                setLoadingState(ui.uploadFromFileButton, false, 'T·∫£i d·ªØ li·ªáu t·ª´ File (m·∫´u)');
            }
        }

        // Event listeners
        ui.translateButton.addEventListener('click', handleTranslate);
        ui.generateExamplesButton.addEventListener('click', handleGenerateExamples);
        ui.summarizeExplainButton.addEventListener('click', handleSummarize);
        ui.generateEssayButton.addEventListener('click', handleGenerateEssay);
        ui.addTermButton.addEventListener('click', handleAddTerm);
        ui.personalTranslationsList.addEventListener('click', handleDeleteTerm);
        ui.personalTranslationsList.addEventListener('click', handleShareTerm); // Listen for share button clicks
        ui.uploadFromFileButton.addEventListener('click', uploadSampleDataFromFile); // New event listener

        ui.takePhotoButton.addEventListener('click', () => {
            ui.imageInput.setAttribute('capture', 'environment');
            ui.imageInput.click();
        });
        ui.chooseImageButton.addEventListener('click', () => {
            ui.imageInput.removeAttribute('capture');
            ui.imageInput.click();
        });

        ui.translateTextFromImageButton.addEventListener('click', handleTranslateTextFromImage);
        ui.solveEdeProblemButton.addEventListener('click', handleSolveEdeProblem);

        ui.dropZone.addEventListener('click', () => ui.imageInput.click());
        ui.imageInput.addEventListener('change', (e) => handleImageSelection(e.target.files[0]));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, () => ui.dropZone.classList.add('bg-blue-100'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, () => ui.dropZone.classList.remove('bg-blue-100'), false);
        });
        ui.dropZone.addEventListener('drop', (e) => handleImageSelection(e.dataTransfer.files[0]));
        
        ui.removeImageButton.addEventListener('click', () => {
            state.selectedImageFile = null;
            ui.imageInput.value = '';
            ui.imagePlaceholder.classList.remove('hidden');
            ui.imagePreviewWrapper.classList.add('hidden');
            ui.translateTextFromImageButton.disabled = true;
            ui.solveEdeProblemButton.disabled = true;
        });
        
        // Web Speech API (Placeholders for now, not LLM-powered directly)
        ui.recordButton.addEventListener('click', () => {
            alert('T√≠nh nƒÉng ghi √¢m gi·ªçng n√≥i ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        });
        ui.speakTranslatedTextButton.addEventListener('click', () => {
            alert('T√≠nh nƒÉng ph√°t √¢m ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        });
        ui.speakAdditionalTextButton.addEventListener('click', () => {
            alert('T√≠nh nƒÉng ph√°t √¢m ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        });
        ui.speakEssayTextButton.addEventListener('click', () => {
            alert('T√≠nh nƒÉng ph√°t √¢m ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        });

        // Firebase Initialization and Auth
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                state.db = getFirestore(app);
                state.auth = getAuth(app);

                onAuthStateChanged(state.auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        ui.userIdDisplay.textContent = `ID Ng∆∞·ªùi d√πng: ${state.userId}`;
                        state.isAuthReady = true;
                        // Start listening to dictionaries only after auth is ready
                        listenToPersonalDictionary();
                        listenToSharedDictionary();
                    } else {
                        // Sign in anonymously if no user is authenticated
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(state.auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(state.auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            ui.userIdDisplay.textContent = `L·ªói x√°c th·ª±c: ${error.message}`;
                            state.isAuthReady = true; // Still mark as ready to avoid blocking UI
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                ui.userIdDisplay.textContent = `L·ªói kh·ªüi t·∫°o Firebase: ${error.message}`;
            }
        }

        // Listen to Personal Dictionary changes in real-time
        function listenToPersonalDictionary() {
            if (!state.db || !state.userId || !state.isAuthReady) return;

            const personalDictRef = collection(state.db, `artifacts/${state.appId}/users/${state.userId}/personal_dictionary`);
            onSnapshot(personalDictRef, (snapshot) => {
                const terms = [];
                snapshot.forEach(doc => {
                    terms.push({ id: doc.id, ...doc.data() });
                });
                state.personalDictionary = terms;
                renderPersonalDictionary();
            }, (error) => {
                console.error("Error listening to personal dictionary:", error);
                ui.personalTranslationsList.innerHTML = `<p class="text-red-500 text-center py-4">L·ªói t·∫£i t·ª´ ƒëi·ªÉn c√° nh√¢n: ${error.message}</p>`;
            });
        }

        // Listen to Shared Dictionary changes in real-time
        function listenToSharedDictionary() {
            if (!state.db || !state.isAuthReady) return;

            const sharedDictRef = collection(state.db, `artifacts/${state.appId}/public/data/shared_dictionary`);
            onSnapshot(sharedDictRef, (snapshot) => {
                const terms = [];
                snapshot.forEach(doc => {
                    terms.push({ id: doc.id, ...doc.data() });
                });
                state.sharedDictionary = terms;f
                renderSharedDictionary();
            }, (error) => {
                console.error("Error listening to shared dictionary:", error);
                ui.sharedTranslationsList.innerHTML = `<p class="text-red-500 text-center py-4">L·ªói t·∫£i t·ª´ ƒëi·ªÉn chung: ${error.message}</p>`;
            });
        }


        function initializeApp() {
            initializeFirebase(); // Initialize Firebase first
            ui.translateTextFromImageButton.disabled = true;
            ui.solveEdeProblemButton.disabled = true;
            setupTabs();
            // Initial render will happen after Firebase auth is ready and listeners are set up
        }
        
        initializeApp();
    });
</script>
</body>
</html>
