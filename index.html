// âœ… index.js â€” ÄÃ£ thay API Gemini báº±ng OpenAI GPT-4 + Tesseract OCR

const OPENAI_API_KEY = "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";

async function callOpenAI(prompt, systemPrompt = "") {
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: "gpt-4",
      messages: [
        ...(systemPrompt ? [{ role: "system", content: systemPrompt }] : []),
        { role: "user", content: prompt }
      ]
    })
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`API Error: ${response.status} - ${error}`);
  }

  const data = await response.json();
  return data.choices?.[0]?.message?.content?.trim() || "KhÃ´ng cÃ³ káº¿t quáº£.";
}

// ğŸ” VÃ­ dá»¥ sá»­ dá»¥ng:

export async function translateWord(word, direction = 'edeToViet') {
  let prompt = "";
  if (direction === 'edeToViet') {
    prompt = `Dá»‹ch tá»« ÃŠÄ‘Ãª sang tiáº¿ng Viá»‡t: \"${word}\".`;
  } else {
    prompt = `Dá»‹ch tá»« tiáº¿ng Viá»‡t sang ÃŠÄ‘Ãª: \"${word}\".`;
  }
  return await callOpenAI(prompt, "Báº¡n lÃ  má»™t trá»£ lÃ½ dá»‹ch tiáº¿ng ÃŠÄ‘Ãª - Viá»‡t.");
}

export async function generateExample(edeWord) {
  const prompt = `Táº¡o má»™t cÃ¢u vÃ­ dá»¥ báº±ng tiáº¿ng ÃŠÄ‘Ãª sá»­ dá»¥ng tá»«: \"${edeWord}\". Sau Ä‘Ã³ dá»‹ch cÃ¢u Ä‘Ã³ sang tiáº¿ng Viá»‡t.`;
  return await callOpenAI(prompt, "Báº¡n lÃ  má»™t trá»£ lÃ½ táº¡o vÃ­ dá»¥ tá»« Ä‘iá»ƒn ÃŠÄ‘Ãª.");
}

export async function generateParagraph(topic) {
  const prompt = `Viáº¿t má»™t Ä‘oáº¡n vÄƒn ngáº¯n báº±ng tiáº¿ng ÃŠÄ‘Ãª (3-5 cÃ¢u) vá» chá»§ Ä‘á»: \"${topic}\".`;
  return await callOpenAI(prompt, "Báº¡n lÃ  má»™t giÃ¡o viÃªn tiáº¿ng ÃŠÄ‘Ãª.");
}

export async function explainConcept(word) {
  const prompt = `Giáº£i thÃ­ch tá»« hoáº·c khÃ¡i niá»‡m tiáº¿ng ÃŠÄ‘Ãª sau báº±ng tiáº¿ng Viá»‡t: \"${word}\".`;
  return await callOpenAI(prompt, "Báº¡n lÃ  nhÃ  ngÃ´n ngá»¯ há»c chuyÃªn giáº£i thÃ­ch tá»« vá»±ng tiáº¿ng ÃŠÄ‘Ãª báº±ng tiáº¿ng Viá»‡t.");
}

// ğŸ–¼ï¸ OCR + Translate áº£nh: dÃ¹ng Tesseract.js Ä‘á»ƒ nháº­n dáº¡ng rá»“i GPT dá»‹ch
import Tesseract from 'tesseract.js';

export async function extractAndTranslateImage(imageFile) {
  const result = await Tesseract.recognize(imageFile, 'vie+eng', {
    logger: m => console.log(m)
  });

  const extractedText = result.data.text.trim();
  if (!extractedText) {
    throw new Error("KhÃ´ng tÃ¬m tháº¥y vÄƒn báº£n trong áº£nh.");
  }

  const translated = await callOpenAI(
    `Dá»‹ch Ä‘oáº¡n vÄƒn tiáº¿ng ÃŠÄ‘Ãª sau sang tiáº¿ng Viá»‡t: \"${extractedText}\"`,
    "Báº¡n lÃ  má»™t trá»£ lÃ½ dá»‹ch vÄƒn báº£n tá»« hÃ¬nh áº£nh."
  );

  return { extractedText, translated };
}
